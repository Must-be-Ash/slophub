#!/usr/bin/env node
/**
 * Test script to make a paid x402 call to Slophub landing page generation endpoint
 * This will make a real payment of $1.99 USDC on Base network
 */

import { wrapFetchWithPayment, decodeXPaymentResponse } from 'x402-fetch';
import { privateKeyToAccount } from 'viem/accounts';
import dotenv from 'dotenv';
import { writeFileSync } from 'fs';
import { join } from 'path';

// Load environment variables
dotenv.config({ path: '.env.local' });

// Test data
const TEST_DATA = {
  url: 'https://www.onepeloton.com/en-CA',
  campaignDescription: `Black Friday sales, ending soon. Save up to $2,310 on the New Cross Training Series. Peloton, bringing the power of studio-level fitness right into your home across Canada. We offer connected hardware like bikes, treadmills, rowers â€” along with on-demand and live classes spanning cardio, strength, yoga, meditation, and more â€” so you can workout wherever you are. With our subscription, you get access to world-class instructors, thousands of classes, and a full range of workouts designed for all fitness levels. Whether you're cycling, running, rowing or stretching, Peloton gives you the flexibility to build a fitness routine that fits your life.`,
  imageUrl: 'https://res.cloudinary.com/peloton-cycle/image/fetch/dpr_2.0,f_auto,q_auto:good,w_600/https://images.ctfassets.net/7vk8puwnesgc/1t2RDtMWApLXAOVLe2jPw0/c5c812deeaa648ef16a957c9e854d0ee/Bike_Render1.png'
};

// Log complete API response to files
function logApiResponse(response, responseData, paymentDetails) {
  const timestamp = new Date().toISOString().replace(/[:.]/g, '-');

  // Prepare complete output object
  const completeOutput = {
    timestamp: new Date().toISOString(),
    request: {
      endpoint: process.env.NEXT_PUBLIC_URL
        ? `${process.env.NEXT_PUBLIC_URL}/api/workflows/untitled-4`
        : 'http://localhost:3000/api/workflows/untitled-4',
      method: 'POST',
      data: TEST_DATA,
    },
    response: {
      status: response.status,
      statusText: response.statusText,
      headers: Object.fromEntries(response.headers.entries()),
      body: responseData,
    },
    payment: paymentDetails,
  };

  // Save JSON
  const jsonPath = join(process.cwd(), `README/logs/x402-call-${timestamp}.json`);
  writeFileSync(jsonPath, JSON.stringify(completeOutput, null, 2));

  // Save Markdown
  const markdown = `# x402 API Call Log

**Timestamp:** ${completeOutput.timestamp}

## Request

**Endpoint:** \`${completeOutput.request.endpoint}\`
**Method:** ${completeOutput.request.method}

**Request Body:**
\`\`\`json
${JSON.stringify(completeOutput.request.data, null, 2)}
\`\`\`

## Response

**Status:** ${completeOutput.response.status} ${completeOutput.response.statusText}

**Response Headers:**
\`\`\`json
${JSON.stringify(completeOutput.response.headers, null, 2)}
\`\`\`

**Response Body:**
\`\`\`json
${JSON.stringify(completeOutput.response.body, null, 2)}
\`\`\`

## Payment Details

${paymentDetails ? `
**Transaction Hash:** ${paymentDetails.transaction}
**BaseScan:** https://basescan.org/tx/${paymentDetails.transaction}
` : 'No payment details available'}

## Key Fields

- **Run ID:** \`${responseData.runId}\`
- **Live URL:** ${responseData.liveUrl || 'NOT PROVIDED âŒ'}
- **Message:** ${responseData.message}

---

*Generated by x402-example-call.js*
`;

  const mdPath = join(process.cwd(), `README/logs/x402-call-${timestamp}.md`);
  writeFileSync(mdPath, markdown);

  console.log('\nğŸ“ Complete output logged to:');
  console.log('   JSON:', jsonPath);
  console.log('   Markdown:', mdPath);
}

async function testRaw402() {
  console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
  console.log('STEP 1: Testing raw HTTP call (should return 402)');
  console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n');

  try {
    const endpoint = process.env.NEXT_PUBLIC_URL
      ? `${process.env.NEXT_PUBLIC_URL}/api/workflows/untitled-4`
      : 'http://localhost:3000/api/workflows/untitled-4';

    console.log('ğŸ“¡ Making raw HTTP POST request (without payment)...');
    console.log('   URL:', endpoint);
    console.log('   Data:', {
      url: TEST_DATA.url.substring(0, 50) + '...',
      campaignDescription: TEST_DATA.campaignDescription.substring(0, 50) + '...',
    });
    console.log('');

    const response = await fetch(endpoint, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(TEST_DATA),
    });

    console.log('ğŸ“Š Response Status:', response.status, response.statusText);
    console.log('ğŸ“‹ Response Headers:');
    response.headers.forEach((value, key) => {
      console.log(`   ${key}: ${value}`);
    });

    const responseText = await response.text();
    console.log('\nğŸ“„ Response Body:');
    try {
      const json = JSON.parse(responseText);
      console.log(JSON.stringify(json, null, 2));

      if (response.status === 402 && json.accepts) {
        console.log('\nğŸ’° Payment Requirements:');
        const requirement = json.accepts[0];
        console.log('   Network:', requirement.network);
        console.log('   Amount:', (parseInt(requirement.maxAmountRequired) / 1000000).toFixed(2), 'USDC');
        console.log('   Pay To:', requirement.payTo);
        console.log('   Resource:', requirement.resource);
      }
    } catch {
      console.log(responseText);
    }

    if (response.status === 402) {
      console.log('\nâœ… SUCCESS! Received 402 Payment Required response as expected!');
    } else {
      console.log(`\nâš ï¸  Received status ${response.status} instead of 402`);
    }

  } catch (error) {
    console.error('âŒ Error making raw request:', error.message);
  }
}

async function testX402Call() {
  console.log('\n\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
  console.log('STEP 2: Making paid x402 call ($1.99 USDC)');
  console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n');

  // Check for private key
  const privateKey = process.env.X402_WALLET_PRIVATE_KEY;
  if (!privateKey) {
    console.log('âŒ X402_WALLET_PRIVATE_KEY not set in .env.local');
    console.log('\nPlease add your private key to .env.local:');
    console.log('   X402_WALLET_PRIVATE_KEY=0x...');
    return;
  }

  try {
    const endpoint = process.env.NEXT_PUBLIC_URL
      ? `${process.env.NEXT_PUBLIC_URL}/api/workflows/untitled-4`
      : 'http://localhost:3000/api/workflows/untitled-4';

    console.log('ğŸ“ Endpoint:', endpoint);
    console.log('ğŸ“ Method: POST');
    console.log('ğŸ“ Test Data:');
    console.log('   URL:', TEST_DATA.url);
    console.log('   Campaign:', TEST_DATA.campaignDescription.substring(0, 100) + '...');
    console.log('   Image:', TEST_DATA.imageUrl.substring(0, 80) + '...');
    console.log('');

    // Initialize wallet
    console.log('ğŸ” Initializing wallet...');
    const account = privateKeyToAccount(privateKey);
    console.log('âœ… Wallet address:', account.address);

    // Wrap fetch with payment handler
    console.log('ğŸ’³ Initializing x402-fetch payment wrapper...');
    const fetchWithPayment = wrapFetchWithPayment(fetch, account, {
      maxPaymentAmount: 2.5, // Allow up to $2.50 USDC (our endpoint costs $1.99)
    });
    console.log('âœ… Payment handler ready (max: $2.50 USDC)\n');

    // Make the paid call
    console.log('ğŸ“¡ Making x402-protected request...');
    console.log('   (x402-fetch will automatically handle payment)\n');

    const startTime = Date.now();

    const response = await fetchWithPayment(endpoint, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(TEST_DATA),
    });

    const duration = ((Date.now() - startTime) / 1000).toFixed(1);

    console.log(`âœ… Request completed in ${duration}s\n`);

    // Parse response
    const result = await response.json();

    // Get payment details
    const paymentHeader = response.headers.get('x-payment-response');
    let paymentResponse = null;
    if (paymentHeader) {
      try {
        paymentResponse = decodeXPaymentResponse(paymentHeader);
      } catch (e) {
        console.log('âš ï¸  Could not decode payment response');
      }
    }

    // Log complete output to files
    logApiResponse(response, result, paymentResponse);

    console.log('\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
    console.log('âœ¨ LANDING PAGE GENERATED!');
    console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n');

    console.log('ğŸ“‹ Workflow Details:');
    console.log('   Run ID:', result.runId);
    console.log('   Live URL:', result.liveUrl);
    console.log('');

    if (paymentResponse) {
      console.log('ğŸ’¸ Payment Transaction:');
      console.log('   TX Hash:', paymentResponse.transaction);
      console.log('   BaseScan:', `https://basescan.org/tx/${paymentResponse.transaction}`);
      console.log('');
    }

    console.log('â³ Workflow Status:');
    console.log('   The landing page is being generated (~3-4 minutes)');
    console.log('   Monitor progress:', `${endpoint.replace('/api/workflows/untitled-4', '')}/workflow/${result.runId}`);
    console.log('   Status API:', `${endpoint}/status?runId=${result.runId}`);
    console.log('');

    console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
    console.log('Next Steps:');
    console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n');
    console.log('1. Monitor workflow progress:');
    console.log(`   curl "${endpoint}/status?runId=${result.runId}"`);
    console.log('');
    console.log('2. View landing page (once complete):');
    console.log(`   open ${result.liveUrl}`);
    console.log('');

    return result;

  } catch (error) {
    console.error('\nâŒ Error:', error.message);

    if (error.response) {
      console.error('\nResponse Status:', error.response.status);
      console.error('Response Data:', error.response.data);
    }

    if (error.stack) {
      console.error('\nStack trace:');
      console.error(error.stack);
    }

    throw error;
  }
}

async function monitorWorkflow(runId) {
  console.log('\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
  console.log('STEP 3: Monitoring Workflow Progress');
  console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n');

  const endpoint = process.env.NEXT_PUBLIC_URL
    ? `${process.env.NEXT_PUBLIC_URL}/api/workflows/untitled-4`
    : 'http://localhost:3000/api/workflows/untitled-4';

  const statusUrl = `${endpoint}/status?runId=${runId}`;

  let attempts = 0;
  const maxAttempts = 120; // 4 minutes at 2s intervals

  while (attempts < maxAttempts) {
    try {
      const response = await fetch(statusUrl);
      const status = await response.json();

      // Clear console line and show current status
      process.stdout.write('\r' + ' '.repeat(100) + '\r');

      const currentStep = status.steps.find(s => s.status === 'running');
      if (currentStep) {
        process.stdout.write(`âš™ï¸  ${currentStep.stepLabel}...`);
      } else if (status.status === 'running') {
        process.stdout.write('âš™ï¸  Processing...');
      }

      // Check if completed
      if (status.status === 'completed') {
        console.log('\n\nâœ… Workflow completed successfully!\n');
        console.log('ğŸ“Š Final Results:');
        console.log('   Live URL:', status.result.liveUrl);
        console.log('   Screenshot:', status.result.screenshotUrl || 'Processing...');
        console.log('');

        console.log('ğŸ‰ Your landing page is ready!');
        console.log(`   Open: ${status.result.liveUrl}`);
        console.log('');

        return status;
      }

      if (status.status === 'failed' || status.status === 'error') {
        console.log('\n\nâŒ Workflow failed\n');
        console.log('Error details:', JSON.stringify(status, null, 2));
        throw new Error('Workflow failed');
      }

      // Wait 2 seconds before next check
      await new Promise(resolve => setTimeout(resolve, 2000));
      attempts++;

    } catch (error) {
      if (error.message === 'Workflow failed') throw error;
      console.error('\nError checking status:', error.message);
      await new Promise(resolve => setTimeout(resolve, 5000));
    }
  }

  console.log('\n\nâ±ï¸  Timeout: Workflow taking longer than expected');
  console.log('   Check status manually:', statusUrl);
}

async function main() {
  console.log('\nğŸš€ Slophub x402 Endpoint Test\n');
  console.log('This will make a REAL payment of $1.99 USDC on Base network\n');

  // Step 1: Test raw 402 response
  await testRaw402();

  // Step 2: Make paid call
  const result = await testX402Call();

  if (!result) {
    console.log('\nâš ï¸  Skipping workflow monitoring (no runId)\n');
    return;
  }

  // Step 3: Monitor progress (optional)
  console.log('\nâ“ Monitor workflow progress? (This will poll for ~4 minutes)');
  console.log('   Press Ctrl+C to skip and monitor manually\n');

  // Wait 5 seconds for user to cancel if they want
  await new Promise(resolve => setTimeout(resolve, 5000));

  await monitorWorkflow(result.runId);

  console.log('\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
  console.log('Test completed successfully!');
  console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n');
}

// Run the test
main().catch(error => {
  console.error('\nâŒ Test failed:', error.message);
  process.exit(1);
});
